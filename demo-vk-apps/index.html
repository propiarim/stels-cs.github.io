<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#536878"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
    <title>Demo vk apps</title>
    <link rel="manifest" href="/manifest.json">
</head>
<body>

<h1>DEMO VK APPS</h1>
<a href="https://vk.com/dev/vk_apps_docs" target="_blank">vk.com/dev/vk_apps_docs</a><br/>
<span id="wh"></span><br/>
<input type="text"/><br/>
<button onclick="vkConnect.send('VKWebAppGetUserInfo', {})">VKWebAppGetUserInfo</button>
<br/>
<button onclick="vkConnect.send('VKWebAppGetPhoneNumber', {})">VKWebAppGetPhoneNumber</button>
<br/>
<button onclick="vkConnect.send('VKWebAppGetEmail', {})">VKWebAppGetEmail</button>
<br/>
<button onclick="vkConnect.send('VKWebAppGetGeodata', {})">VKWebAppGetGeodata</button>
<br/>
<button onclick="vkConnect.send('VKWebAppAllowNotifications', {})">VKWebAppAllowNotifications</button>
<br/>
<button onclick="vkConnect.send('VKWebAppDenyNotifications', {})">VKWebAppDenyNotifications</button>
<br/>
<button onclick="vkConnect.send('VKWebAppJoinGroup', {group_id:58810575})">VKWebAppJoinGroup</button>
<br/>
<button onclick="vkConnect.send('VKWebAppOpenQR', {})">VKWebAppOpenQR</button><br/>
<button onclick="vkConnect.send('VKWebAppGetClientVersion', {})">VKWebAppGetClientVersion</button><br/>
<button onclick="vkConnect.send('VKWebAppShowWallPostBox', {message:'VKWebAppShowWallPostBox'})">VKWebAppShowWallPostBox</button><br/>
<button onclick="vkConnect.send('VKWebAppOpenContacts', {})">VKWebAppOpenContacts</button><br/>
<button onclick="vkConnect.send('VKWebAppShare', {link:'https://vk.com/app6825462'})">VKWebAppShare</button><br/>
<button onclick="vkConnect.send('VKWebAppAllowMessagesFromGroup', {group_id:1, key:'dBuBKe1kFcdemzB'})">VKWebAppAllowMessagesFromGroup</button><br/>
<button onclick="vkConnect.send('VKWebAppGetAuthToken', {app_id:6825462,scope:'friends,photos,video,pages,status,notes,wall,ads,docs,groups,stats,market'})">VKWebAppGetAuthToken</button><br/>
<button onclick='vkConnect.send("VKWebAppCallAPIMethod", {"method":"users.get","params": {"user_ids": "1", "v":"5.92", "access_token":accessToken}, "request_id":99564})'>connect.send("VKWebAppCallAPIMethod", {"method":"users.get","params":{"user_ids": "1","v":"5.92","access_token":accessToken},"request_id":99564})</button><br/>
<button onclick='consolePrint(window.location.href.replace(/([&\?])/ug, "\n$1"))'>window.location.href</button><br/>
<button onclick='window.location.reload()'>window.location.reload()</button><br/>
<button onclick='consolePrint(("serviceWorker" in window.navigator) ? "Has service worker" : "No service worker")'>("serviceWorker" in window.navigator) ? "Has service worker" : "No service worker"</button><br/>
<button onclick='consolePrint(window.applicationCache ? "Has window.applicationCache, status:" + window.applicationCache.status  : "No window.applicationCache")'>Check window.applicationCache</button><br/>


<h3>Events:</h3>
<pre id="console"></pre>


<button class="add-button">Add to home screen</button>
<script src="./vk-connect.js"></script>

<script>
	let consoleNode = document.getElementById('console')
    let accessToken = ""

    document.getElementById('wh').innerText = window.innerHeight
    window.addEventListener("addEventListener", function () {
		document.getElementById('wh').innerText = window.innerHeight
        setTimeout(() => {
			document.getElementById('wh').innerText = window.innerHeight
        }, 500)
    })

	function consolePrint(text) {
		const now = new Date()
		const time = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ":" + now.getMilliseconds() + 'ms'
		let tn = document.createTextNode(time + ": " + text + "\n")
		consoleNode.prepend(tn)
	}

	vkConnect.subscribe(event => {
		const {type, data} = event.detail
        if (type !== undefined || data !== undefined) {
        	if (data === undefined) {
			    consolePrint(type + ": " + JSON.stringify(event, null, 2))
            } else {
			    consolePrint(type + ": " + JSON.stringify(data, null, 2))
                if (type === 'VKWebAppAccessTokenReceived') {
                    accessToken = data.access_token
                }
            }
		} else {
        	consolePrint(JSON.stringify(event,null,2))
        }
	})

	vkConnect.send('VKWebAppInit', {})
</script>

<script>
	if ('serviceWorker' in navigator) {
		console.log("Will service worker register?")
		navigator.serviceWorker.register('/service-worker.js').then(function (reg) {
			console.log("Yes it did.")
		}).catch(function (err) {
			console.log("No it didn't. This happened: ", err)
		})
	}
</script>

<script>
	let deferredPrompt
	const addBtn = document.querySelector('.add-button')
	addBtn.style.display = 'none'
	window.addEventListener('beforeinstallprompt', (e) => {
		// Prevent Chrome 67 and earlier from automatically showing the prompt
		e.preventDefault()
		// Stash the event so it can be triggered later.
		deferredPrompt = e
		// Update UI to notify the user they can add to home screen
		addBtn.style.display = 'block'

		addBtn.addEventListener('click', (e) => {
			// hide our user interface that shows our A2HS button
			addBtn.style.display = 'none'
			// Show the prompt
			deferredPrompt.prompt()
			// Wait for the user to respond to the prompt
			deferredPrompt.userChoice.then((choiceResult) => {
				if (choiceResult.outcome === 'accepted') {
					console.log('User accepted the A2HS prompt')
				} else {
					console.log('User dismissed the A2HS prompt')
				}
				deferredPrompt = null
			})
		})
	})
</script>
</body>
</html>
