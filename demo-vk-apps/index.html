<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#536878"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo vk apps</title>
    <link rel="manifest" href="/manifest.json">
</head>
<body>

<h1>DEMO VK APPS</h1>

<button onclick="vkConnect.send('VKWebAppGetUserInfo', {})">VKWebAppGetUserInfo</button>
<br/>
<button onclick="vkConnect.send('VKWebAppGetPhoneNumber', {})">VKWebAppGetPhoneNumber</button>
<br/>
<button onclick="vkConnect.send('VKWebAppGetEmail', {})">VKWebAppGetEmail</button>
<br/>
<button onclick="vkConnect.send('VKWebAppGetGeodata', {})">VKWebAppGetGeodata</button>
<br/>
<button onclick="vkConnect.send('VKWebAppAllowNotifications', {})">VKWebAppAllowNotifications</button>
<br/>
<button onclick="vkConnect.send('VKWebAppDenyNotifications', {})">VKWebAppDenyNotifications</button>
<br/>
<button onclick="vkConnect.send('VKWebAppJoinGroup', {group_id:58810575})">VKWebAppJoinGroup</button>
<br/>
<button onclick="vkConnect.send('VKWebAppOpenQR', {})">VKWebAppOpenQR</button>
<br/>

<h3>Events:</h3>
<pre id="console"></pre>


<button class="add-button">Add to home screen</button>
<script src="./vk-connect.js"></script>

<script>
	let consoleNode = document.getElementById('console')

	function consolePrint(text) {
		const now = new Date()
		const time = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ":" + now.getMilliseconds() + 'ms'
		let tn = document.createTextNode(time + ": " + text + "\n")
		consoleNode.appendChild(tn)
	}

	vkConnect.subscribe(event => {
		const {type, data} = event.detail
        if (type !== undefined || data !== undefined) {
			consolePrint(type + ": " + JSON.stringify(data, null, 2))
		} else {
        	consolePrint(JSON.stringify(event,null,2))
        }
	})

	vkConnect.send('VKWebAppInit', {})
</script>

<script>
	if ('serviceWorker' in navigator) {
		console.log("Will service worker register?")
		navigator.serviceWorker.register('/service-worker.js').then(function (reg) {
			console.log("Yes it did.")
		}).catch(function (err) {
			console.log("No it didn't. This happened: ", err)
		})
	}
</script>

<script>
	let deferredPrompt
	const addBtn = document.querySelector('.add-button')
	addBtn.style.display = 'none'
	window.addEventListener('beforeinstallprompt', (e) => {
		// Prevent Chrome 67 and earlier from automatically showing the prompt
		e.preventDefault()
		// Stash the event so it can be triggered later.
		deferredPrompt = e
		// Update UI to notify the user they can add to home screen
		addBtn.style.display = 'block'

		addBtn.addEventListener('click', (e) => {
			// hide our user interface that shows our A2HS button
			addBtn.style.display = 'none'
			// Show the prompt
			deferredPrompt.prompt()
			// Wait for the user to respond to the prompt
			deferredPrompt.userChoice.then((choiceResult) => {
				if (choiceResult.outcome === 'accepted') {
					console.log('User accepted the A2HS prompt')
				} else {
					console.log('User dismissed the A2HS prompt')
				}
				deferredPrompt = null
			})
		})
	})
</script>
</body>
</html>
